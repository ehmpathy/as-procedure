# execution log: bundle all prod deps' .d.ts

---

## phase 0: prep

### 0.1 add tsdown as dev dependency

**status:** ✅ complete

**notes:**
- tsdown already present in devDependencies at `0.20.0-beta.3`

**verification:**
```
npm list tsdown
as-procedure@1.1.11
└── tsdown@0.20.0-beta.3
```

---

### 0.2 add `forwarded` field to package.json

**status:** ✅ complete

**notes:**
- added `forwarded` array with dependencies that re-export types
- identified via `export * from 'pkg'` patterns in src/index.ts

**changes:**
```json
"forwarded": [
  "domain-glossary-procedure",
  "simple-log-methods"
]
```

---

### 0.3 audit exports for explicit return types

**status:** ✅ complete

**notes:**
- audited all exports in src/index.ts
- fixed `getName` in HasName.ts: added explicit `: string` return type
- fixed `inferProcedureName`: changed to input object pattern with explicit `: string` return type
- updated call site in asProcedure.ts to use `{ fileName: callerFileName }`

---

## phase 1: tsdown configuration

### 1.1 create tsdown.config.ts

**status:** ✅ complete

**notes:**
- created tsdown.config.ts with dts.resolve read from pkg.forwarded
- used `with { type: 'json' }` import assertion for package.json
- added `noExternal: pkg.forwarded ?? []` to bundle runtime code from forwarded deps
- set `resolver: 'tsc'` for maximum compatibility

**file created:**
```ts
import { defineConfig } from 'tsdown';
import pkg from './package.json' with { type: 'json' };

export default defineConfig({
  entry: ['src/index.ts'],
  outDir: 'dist',
  format: ['esm'],
  dts: {
    resolve: pkg.forwarded ?? [],
    resolver: 'tsc',
  },
  noExternal: pkg.forwarded ?? [],
  clean: true,
});
```

---

### 1.2 update package.json build command

**status:** ✅ complete

**notes:**
- changed `build:compile` from `tsc -p ./tsconfig.build.json` to `tsdown`

---

### 1.3 update package.json exports

**status:** ✅ complete

**notes:**
- tsdown outputs `.mjs` and `.d.mts` files for esm format
- updated main, module, types, and exports to use `.mjs`/`.d.mts` extensions
- added `"type": "module"` for esm support
- renamed commitlint.config.js to .cjs for commonjs compatibility

**changes:**
```json
{
  "type": "module",
  "main": "dist/index.mjs",
  "module": "dist/index.mjs",
  "types": "dist/index.d.mts",
  "exports": {
    ".": {
      "types": "./dist/index.d.mts",
      "import": "./dist/index.mjs"
    }
  }
}
```

---

## phase 2: build validation

### 2.1 run build

**status:** ✅ complete

**notes:**
- build produces dist/index.mjs (163 kb) and dist/index.d.mts (11 kb)
- warnings from transitive deps (iso-time, visualogic) about absent exports are not blockers

**output:**
```
tsdown v0.20.0-beta.3 powered by rolldown v1.0.0-beta.60
dist/index.mjs    163.14 kB
dist/index.d.mts   10.78 kB
Build complete in 7262ms
```

---

### 2.2 verify bundled types

**status:** ✅ complete

**notes:**
- confirmed no external imports from forwarded deps in dist/index.d.mts
- Procedure type inlined from domain-glossary-procedure
- LogMethods, LogLevel, LogTrail, etc. inlined from simple-log-methods
- non-forwarded deps (type-fns, helpful-errors, serde-fns) remain external

---

## phase 3: test suite

### 3.1 run type checks

**status:** ✅ complete

**notes:**
- excluded tsdown.config.ts from tsconfig.json to avoid import assertion errors
- `npm run test:types` passes

---

### 3.2 run unit tests

**status:** ✅ complete

**notes:**
- all unit tests pass (withExpectOutkey, withExpectOutput)

---

### 3.3 create acceptance test

**status:** ✅ complete

**notes:**
- created blackbox/dts-bundle.acceptance.test.ts
- tests verify bundled types do not import from forwarded deps
- tests verify LogMethods interface and Procedure type are inlined

**file created:** `blackbox/dts-bundle.acceptance.test.ts`

---

## phase 4: final validation

### 4.1 run full test suite

**status:** ✅ complete

**notes:**
- fixed biome import organization in acceptance test
- renamed commitlint.config.js to .cjs for commonjs compat with "type": "module"
- all tests pass: commits, types, format, lint, unit, integration, acceptance

---

### 4.2 verify package

**status:** ✅ complete

**notes:**
- dist/ contains index.mjs (163 kb) and index.d.mts (11 kb)
- package.json exports correctly point to dist files
- files field includes /dist for npm publish
- bundled types confirmed to inline forwarded dep types

---

## summary

| step | status |
|------|--------|
| 0.1 add tsdown | ✅ |
| 0.2 add forwarded field | ✅ |
| 0.3 audit return types | ✅ |
| 1.1 create tsdown.config.ts | ✅ |
| 1.2 update build command | ✅ |
| 1.3 update exports | ✅ |
| 2.1 run build | ✅ |
| 2.2 verify bundled types | ✅ |
| 3.1 run type checks | ✅ |
| 3.2 run unit tests | ✅ |
| 3.3 create acceptance test | ✅ |
| 4.1 run full test suite | ✅ |
| 4.2 verify package | ✅ |

## files changed

- `package.json` - added forwarded field, type:module, updated exports
- `tsdown.config.ts` - created, configures dts bundle
- `tsconfig.json` - excluded tsdown.config.ts
- `commitlint.config.js` → `commitlint.config.cjs` - renamed for commonjs compat
- `src/domain.objects/HasName.ts` - added explicit return type to getName
- `src/domain.operations/inferProcedureName.ts` - refactored to input pattern with explicit return
- `src/domain.operations/asProcedure.ts` - updated inferProcedureName call
- `blackbox/dts-bundle.acceptance.test.ts` - created acceptance test
