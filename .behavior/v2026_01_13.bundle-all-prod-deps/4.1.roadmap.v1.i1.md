# roadmap: bundle all prod deps' .d.ts

---

## overview

execute the blueprint in `3.3.blueprint.v1.i1.md` to migrate build from `tsc` to `tsdown` with `dts.resolve` for forwarded type bundle.

---

## phase 0: prep

### 0.1 add tsdown as dev dependency

- [ ] install tsdown

**acceptance criteria:**
- tsdown is in devDependencies
- pnpm install succeeds

**verification:**
```sh
pnpm add -D tsdown
npm list tsdown
```

---

### 0.2 add `forwarded` field to package.json

- [ ] add forwarded array with deps that use `export * from 'pkg'`

**acceptance criteria:**
- package.json contains `"forwarded": ["domain-glossary-procedure", "simple-log-methods"]`
- both entries are also in `dependencies`

**verification:**
```sh
cat package.json | jq '.forwarded'
cat package.json | jq '.dependencies | keys | map(select(. == "domain-glossary-procedure" or . == "simple-log-methods"))'
```

---

### 0.3 audit exports for explicit return types

- [ ] check all exported functions have explicit return types (required for isolatedDeclarations)

**acceptance criteria:**
- all exports in `src/index.ts` transitively have explicit return types
- no inferred return types on public api

**verification:**
```sh
npm run test:types
```

---

## phase 1: tsdown configuration

### 1.1 create tsdown.config.ts

- [ ] create config that reads from `package.json.forwarded`

**acceptance criteria:**
- `tsdown.config.ts` exists at repo root
- config uses `pkg.forwarded ?? []` for `dts.resolve`
- uses `resolver: 'tsc'` for compatibility

**verification:**
```sh
cat tsdown.config.ts
```

---

### 1.2 update package.json build command

- [ ] change `build:compile` to use `tsdown`

**acceptance criteria:**
- `build:compile` runs `tsdown`
- prior `tsc` command replaced

**verification:**
```sh
cat package.json | jq '.scripts["build:compile"]'
```

---

### 1.3 update package.json exports

- [ ] ensure exports point to tsdown output paths

**acceptance criteria:**
- `main`, `module`, `types` point to `dist/`
- exports map has correct paths

**verification:**
```sh
cat package.json | jq '{main, module, types, exports}'
```

---

## phase 2: build validation

### 2.1 run build

- [ ] execute build and verify output

**acceptance criteria:**
- build succeeds without errors
- `dist/index.js` exists
- `dist/index.d.ts` exists

**verification:**
```sh
npm run build
ls -la dist/
```

---

### 2.2 verify bundled types

- [ ] inspect dist/index.d.ts for inlined types

**acceptance criteria:**
- no `from 'simple-log-methods'` imports in dist/index.d.ts
- no `from 'domain-glossary-procedure'` imports in dist/index.d.ts
- `LogMethods` interface is inlined
- `Procedure` type is inlined

**verification:**
```sh
grep -c "from 'simple-log-methods'" dist/index.d.ts || echo "0 matches - good"
grep -c "from 'domain-glossary-procedure'" dist/index.d.ts || echo "0 matches - good"
grep -c "LogMethods" dist/index.d.ts
grep -c "Procedure" dist/index.d.ts
```

---

## phase 3: test suite

### 3.1 run type checks

- [ ] verify types pass

**acceptance criteria:**
- `npm run test:types` passes

**verification:**
```sh
npm run test:types
```

---

### 3.2 run unit tests

- [ ] verify prior behavior preserved

**acceptance criteria:**
- all unit tests pass

**verification:**
```sh
npm run test:unit
```

---

### 3.3 create acceptance test

- [ ] add `src/blackbox/dts-bundle.acceptance.test.ts`

**acceptance criteria:**
- test file exists
- test reads from `package.json.forwarded`
- test verifies no external imports for forwarded deps

**verification:**
```sh
cat src/blackbox/dts-bundle.acceptance.test.ts
npm run test:acceptance
```

---

## phase 4: final validation

### 4.1 run full test suite

- [ ] all tests pass

**acceptance criteria:**
- types pass
- unit tests pass
- acceptance tests pass

**verification:**
```sh
npm run test
```

---

### 4.2 verify package

- [ ] npm pack produces valid tarball

**acceptance criteria:**
- `npm pack` succeeds
- tarball contains dist/index.js and dist/index.d.ts

**verification:**
```sh
npm pack --dry-run
```

---

## completion checklist

| step | status |
|------|--------|
| 0.1 add tsdown | [ ] |
| 0.2 add forwarded field | [ ] |
| 0.3 audit return types | [ ] |
| 1.1 create tsdown.config.ts | [ ] |
| 1.2 update build command | [ ] |
| 1.3 update exports | [ ] |
| 2.1 run build | [ ] |
| 2.2 verify bundled types | [ ] |
| 3.1 run type checks | [ ] |
| 3.2 run unit tests | [ ] |
| 3.3 create acceptance test | [ ] |
| 4.1 run full test suite | [ ] |
| 4.2 verify package | [ ] |

---

## rollback

if issues arise at any phase:

1. revert `package.json` changes (build command, forwarded field)
2. remove `tsdown.config.ts`
3. remove `tsdown` from devDependencies
4. prior `tsconfig.build.json` remains unchanged

---

## references

- [3.3.blueprint.v1.i1.md](./3.3.blueprint.v1.i1.md)
- [pattern.forwarded-deps.md](../../.agent/repo=.this/role=any/briefs/pattern.forwarded-deps.md)
